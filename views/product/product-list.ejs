<%- include('../shared/asideBar') %>

<main class="flex-grow p-8 ml-0 sm:ml-20 lg:ml-64 overflow-hidden">
  <h1 class="text-4xl font-bold mb-8 sm:mt-7 mt-9">Products List</h1>

  <div class="mb-4 flex justify-between items-center flex-wrap">
    <!-- Add new product -->
    <div class="w-full sm:w-auto mb-4 sm:mb-0 sm:ml-auto">
      <button class="px-4 py-2 bg-[#DB4444] text-white rounded-lg hover:bg-[#de2d2d] transition flex items-center space-x-2">
        <i class="bi bi-plus-circle"></i>
        <a href="/admin/product/add-product" class="focus:outline-none">Add New Product</a>
      </button>
    </div>
  </div>

  <!-- Messages -->
  <div id="message-container" class="mb-4"></div>

  <!-- Product Table -->
  <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
    <div class="overflow-x-auto">
      <table class="min-w-full table-auto">
        <thead class="bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300">
          <tr>
            <th class="px-4 py-2 text-left w-1/6">Image</th>
            <th class="px-4 py-2 text-left w-1/6">Product Name</th>
            <th class="px-4 py-2 text-left w-1/6">Category</th>
            <th class="px-4 py-2 text-left w-1/6">Brand</th>
            <th class="px-4 py-2 text-left w-1/6">Stock</th>
            <th class="px-4 py-2 text-left w-1/6">Price</th>
            <th class="px-4 py-2 text-left w-1/6">Actions</th>
          </tr>
        </thead>
        <tbody class="text-gray-700 dark:text-gray-300" id="productList">
          <!-- Populated via AJAX -->
        </tbody>
      </table>
      <p id="noResults" class="text-center text-red-500 font-semibold hidden mt-4">No products found</p>
    </div>
  </div>

  <!-- Pagination Controls -->
  <div class="flex justify-center mt-6">
    <nav id="pagination" aria-label="Pagination" class="inline-flex -space-x-px rounded-md shadow-sm"></nav>
  </div>
</main>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const productList = document.getElementById("productList");
    const messageContainer = document.getElementById("message-container");
    const pagination = document.getElementById("pagination");
    const noResults = document.getElementById("noResults");
    let currentPage = 1;

    // Fetch initial products
    fetchProducts(currentPage);

    // AJAX Delete functionality
    productList.addEventListener("click", async function (e) {
      const button = e.target.closest(".delete-btn");
      if (!button) return;

      const productId = button.dataset.productId;
      const page = button.dataset.page;

      try {
        const response = await fetch("/admin/product/delete-product", {
          method: "DELETE",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ productId, page }),
        });

        const result = await response.json();

        messageContainer.innerHTML = "";

        if (response.ok) {
          showMessage(result.message, "success");
          updateProductTable(result.products);
          updatePagination(result.currentPage, result.totalPages);
          currentPage = result.currentPage;
        } else {
          showMessage(result.error || "An error occurred.", "error");
        }
      } catch (error) {
        console.error("❌ AJAX Delete Error:", error);
        showMessage("Network error. Please try again.", "error");
      }
    });

    // AJAX Pagination functionality
    pagination.addEventListener("click", async function (e) {
      const target = e.target.closest(".page-link");
      if (!target) return;

      e.preventDefault();
      const page = parseInt(target.dataset.page);
      fetchProducts(page);
    });

    // Fetch products function
    async function fetchProducts(page) {
      try {
        const response = await fetch(`/admin/product/product-list?page=${page}`, {
          headers: { "X-Requested-With": "XMLHttpRequest" },
        });

        const result = await response.json();

        if (response.ok) {
          updateProductTable(result.products);
          updatePagination(result.currentPage, result.totalPages);
          currentPage = result.currentPage;
        } else {
          console.error("❌ Fetch Products Error:", result.error);
          showMessage("Error fetching products.", "error");
        }
      } catch (error) {
        console.error("❌ AJAX Fetch Error:", error);
        showMessage("Network error. Please try again.", "error");
      }
    }

    // Update product table
    function updateProductTable(products) {
      productList.innerHTML = "";
      if (products.length === 0) {
        productList.innerHTML = '<tr><td colspan="7" class="text-center text-red-500 font-semibold py-4">No products found.</td></tr>';
        noResults.style.display = "block";
      } else {
        products.forEach(product => {
          const row = `
            <tr class="border-t border-gray-200 dark:border-gray-600 product-row" data-product-id="${product._id}">
              <td class="px-4 py-2"><img src="${product.image}" alt="Product Image" class="w-16 h-16 object-cover rounded"></td>
              <td class="px-4 py-2 product-name">${product.name}</td>
              <td class="px-4 py-2 category-name">${product.category}</td>
              <td class="px-4 py-2 brand-name">${product.brand}</td>
              <td class="px-4 py-2">${product.quantity}</td>
              <td class="px-4 py-2">$${product.price}</td>
              <td class="pr-5 py-2 flex items-center gap-3">
                <a href="/admin/product/edit/${product._id}" class="px-4 py-2 text-blue-600">Edit</a>
                <button class="delete-btn px-4 py-2 text-red-600" data-product-id="${product._id}" data-page="${currentPage}">Delete</button>
              </td>
            </tr>`;
          productList.insertAdjacentHTML("beforeend", row);
        });
        noResults.style.display = "none";
      }
    }

    // Update pagination
    function updatePagination(currentPage, totalPages) {
      const maxVisiblePages = 5;
      let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
      let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
      if (endPage - startPage + 1 < maxVisiblePages) {
        startPage = Math.max(1, endPage - maxVisiblePages + 1);
      }

      let html = "";
      if (currentPage > 1) {
        html += `<button data-page="${currentPage - 1}" class="page-link relative inline-flex items-center px-3 py-2 text-sm font-medium text-white bg-[#DB4444] border border-[#DB4444] rounded-l-md hover:bg-[#de2d2d] focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
        </button>`;
      }

      if (startPage > 1) {
        html += `<button data-page="1" class="page-link relative inline-flex items-center px-4 py-2 text-sm font-medium bg-white text-gray-700 border border-gray-300 hover:bg-gray-50 dark:bg-gray-700 dark:text-gray-300 dark:border-gray-600 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">1</button>`;
        if (startPage > 2) {
          html += `<span class="relative inline-flex items-center px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 dark:bg-gray-700 dark:text-gray-300 dark:border-gray-600">...</span>`;
        }
      }

      for (let i = startPage; i <= endPage; i++) {
        html += `<button data-page="${i}" class="page-link relative inline-flex items-center px-4 py-2 text-sm font-medium ${currentPage === i ? 'bg-[#DB4444] text-white border-[#DB4444]' : 'bg-white text-gray-700 border-gray-300 hover:bg-gray-50 dark:bg-gray-700 dark:text-gray-300 dark:border-gray-600 dark:hover:bg-gray-600'} border ${i === startPage ? '' : '-ml-px'} focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">${i}</button>`;
      }

      if (endPage < totalPages) {
        if (endPage < totalPages - 1) {
          html += `<span class="relative inline-flex items-center px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 dark:bg-gray-700 dark:text-gray-300 dark:border-gray-600">...</span>`;
        }
        html += `<button data-page="${totalPages}" class="page-link relative inline-flex items-center px-4 py-2 text-sm font-medium bg-white text-gray-700 border border-gray-300 hover:bg-gray-50 dark:bg-gray-700 dark:text-gray-300 dark:border-gray-600 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">${totalPages}</button>`;
      }

      if (currentPage < totalPages) {
        html += `<button data-page="${currentPage + 1}" class="page-link relative inline-flex items-center px-3 py-2 text-sm font-medium text-white bg-[#DB4444] border border-[#DB4444] rounded-r-md hover:bg-[#de2d2d] focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
        </button>`;
      }

      pagination.innerHTML = html;
    }

    // Show message helper
    function showMessage(text, type) {
      const div = document.createElement("div");
      div.className = `alert-message ${type === "success" ? "bg-green-100 text-green-700 border-green-400" : "bg-red-100 text-red-700 border-red-400"} border p-3 rounded-lg text-center`;
      div.textContent = text;
      messageContainer.appendChild(div);
      setTimeout(() => {
        messageContainer.innerHTML = "";
      }, 5000);
    }
  });
</script>

<script src="/js/main.js"></script>
</body>
</html>